{
  "url": "https://docs.circuitpython.org/en/latest/docs/porting.html",
  "title": "Architecture",
  "content": "We love CircuitPython and would love to see it come to more microcontroller platforms. Since 3.0 we’ve reworked CircuitPython to make it easier than ever to add support. While there are some major differences between ports, this page covers the similarities that make CircuitPython what it is and how that core fits into a variety of microcontrollers.\n\nThere are three core pieces to CircuitPython:\n\nThe first is the Python VM that the awesome MicroPython devs have created. These VMs are written to be portable so there is not much needed when moving to a different microcontroller, especially if it is ARM based.\n\nThe second is the infrastructure around those VMs which provides super basic operating system functionality such as initializing hardware, running USB, prepping file systems and automatically running user code on boot. In CircuitPython we’ve dubbed this component the supervisor because it monitors and facilitates the VMs which run user Python code. Porting involves the supervisor because many of the tasks it does while interfacing with the hardware. Once complete, the REPL works and debugging can migrate to a Python based approach rather than C.\n\nThe third core piece is the plethora of low level APIs that CircuitPython provides as the foundation for higher level libraries including device drivers. These APIs are called from within the running VMs through the Python interfaces defined in shared-bindings. These bindings rely on the underlying common_hal C API to implement the functionality needed for the Python API. By splitting the two, we work to ensure standard functionality across which means that libraries and examples apply across ports with minimal changes.\n\nThe first step to porting to a new microcontroller is getting a build running. The primary goal of it should be to get main.c compiling with the assistance of the supervisor/supervisor.mk file. Port specific code should be isolated to the port’s directory (in the top level until the ports directory is present). This includes the Makefile and any C library resources. Make sure these resources are compatible with the MIT License of the rest of the code!\n\nCircuitpython has a number of modules enabled by default in py/circuitpy_mpconfig.mk. Most of these modules will need to be disabled in mpconfigboard.mk during the early stages of a port in order for it to compile. As the port progresses in module support, this list can be pruned down as a natural “TODO” list. An example minimal build list is shown below:\n\nOnce your build is setup, the next step should be to get your clocks going as you expect from the supervisor. The supervisor calls port_init to allow for initialization at the beginning of main. This function also has the ability to request a safe mode state which prevents the supervisor from running user code while still allowing access to the REPL and other resources.\n\nThe core port initialization and reset methods are defined in supervisor/port.c and should be the first to be implemented. It’s required that they be implemented in the supervisor directory within the port directory. That way, they are always in the expected place.\n\nThe supervisor also uses three linker variables, _ezero, _estack and _ebss to determine memory layout for stack overflow checking.\n\nGetting the REPL going is a huge step. It involves a bunch of initialization to be done correctly and is a good sign you are well on your porting way. To get the REPL going you must implement the functions and definitions from supervisor/serial.h with a corresponding supervisor/serial.c in the port directory. This involves sending and receiving characters over some sort of serial connection. It could be UART or USB for example.",
  "headings": [
    {
      "level": "h1",
      "text": "Architecture",
      "id": ""
    },
    {
      "level": "h1",
      "text": "Porting",
      "id": ""
    },
    {
      "level": "h2",
      "text": "Step 1: Getting building",
      "id": ""
    },
    {
      "level": "h2",
      "text": "Step 2: Init",
      "id": ""
    },
    {
      "level": "h2",
      "text": "Step 3: REPL",
      "id": ""
    }
  ],
  "code_samples": [
    {
      "code": "# These modules are implemented in ports/<port>/common-hal:\n\n# Typically the first module to create\nCIRCUITPY_MICROCONTROLLER = 0\n# Typically the second module to create\nCIRCUITPY_DIGITALIO = 0\n# Other modules:\nCIRCUITPY_ANALOGIO = 0\nCIRCUITPY_BUSIO = 0\nCIRCUITPY_COUNTIO = 0\nCIRCUITPY_NEOPIXEL_WRITE = 0\nCIRCUITPY_PULSEIO = 0\nCIRCUITPY_OS = 0\nCIRCUITPY_NVM = 0\nCIRCUITPY_AUDIOBUSIO = 0\nCIRCUITPY_AUDIOIO = 0\nCIRCUITPY_ROTARYIO = 0\nCIRCUITPY_RTC = 0\nCIRCUITPY_SDCARDIO = 0\nCIRCUITPY_FRAMEBUFFERIO = 0\nCIRCUITPY_FREQUENCYIO = 0\nCIRCUITPY_I2CTARGET = 0\nCIRCUITPY_SPITARGET = 0\n# Requires SPI, PulseIO (stub ok):\nCIRCUITPY_DISPLAYIO = 0\n\n# These modules are implemented in shared-module/ - they can be included in\n# any port once their prerequisites in common-hal are complete.\n# Requires DigitalIO:\nCIRCUITPY_BITBANGIO = 0\n# Requires neopixel_write or SPI (dotstar)\nCIRCUITPY_PIXELBUF = 0\n# Requires OS\nCIRCUITPY_RANDOM = 0\n# Requires OS, filesystem\nCIRCUITPY_STORAGE = 0\n# Requires Microcontroller\nCIRCUITPY_TOUCHIO = 0\n# Requires USB\nCIRCUITPY_USB_HID = 0\nCIRCUITPY_USB_MIDI = 0\n# Does nothing without I2C\nCIRCUITPY_REQUIRE_I2C_PULLUPS = 0\n# No requirements, but takes extra flash\nCIRCUITPY_ULAB = 0",
      "language": "typescript"
    }
  ],
  "patterns": [],
  "links": [
    "https://docs.circuitpython.org/en/latest/docs/index.html",
    "https://docs.circuitpython.org/en/latest/shared-bindings/index.html",
    "https://docs.circuitpython.org/en/latest/docs/library/index.html",
    "https://docs.circuitpython.org/en/latest/docs/supported_ports.html",
    "https://docs.circuitpython.org/en/latest/docs/troubleshooting.html",
    "https://docs.circuitpython.org/en/latest/docs/libraries.html",
    "https://docs.circuitpython.org/en/latest/docs/workflows.html",
    "https://docs.circuitpython.org/en/latest/docs/environment.html",
    "https://docs.circuitpython.org/en/latest/docs/design_guide.html",
    "https://docs.circuitpython.org/en/latest/docs/porting.html",
    "https://docs.circuitpython.org/en/latest/docs/common_hal.html",
    "https://docs.circuitpython.org/en/latest/docs/reference/glossary.html",
    "https://docs.circuitpython.org/en/latest/docs/LICENSE.html"
  ]
}